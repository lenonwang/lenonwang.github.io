<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 6.3.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png">
  <link rel="mask-icon" href="/images/safari-pinned-tab.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css" integrity="sha256-AbA177XfpSnFEvgpYu1jMygiLabzPCJCRIBtR5jGc0k=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"lenonwang.github.io","root":"/","images":"/images","scheme":"Gemini","darkmode":true,"version":"8.13.1","exturl":false,"sidebar":{"position":"left","display":"hide","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>

    <meta name="description" content="开始使用Android Gradle Plugin来帮助你进行项目的构建   一切的一切到要从 阿里云emas移动推送 说起, 这玩意的接入过程暂且不表, 有兴趣的可以看一看, 尤其是其控制台. 接入后主要需要在 build.gradle 中进行配置, 同时还有一份配置文件在 app 目录下. 但是emas的配置文件只能配置一份, (甚至不能实时更新, 需要 gradle clean ), 而实际">
<meta property="og:type" content="article">
<meta property="og:title" content="开始使用Android Gradle Plugin来帮助你进行项目的构建">
<meta property="og:url" content="https://lenonwang.github.io/2023/04/18/%E5%BC%80%E5%A7%8B%E4%BD%BF%E7%94%A8Android%20Gradle%20Plugin%E6%9D%A5%E5%B8%AE%E5%8A%A9%E4%BD%A0%E8%BF%9B%E8%A1%8C%E9%A1%B9%E7%9B%AE%E7%9A%84%E6%9E%84%E5%BB%BA/index.html">
<meta property="og:site_name" content="程序猿">
<meta property="og:description" content="开始使用Android Gradle Plugin来帮助你进行项目的构建   一切的一切到要从 阿里云emas移动推送 说起, 这玩意的接入过程暂且不表, 有兴趣的可以看一看, 尤其是其控制台. 接入后主要需要在 build.gradle 中进行配置, 同时还有一份配置文件在 app 目录下. 但是emas的配置文件只能配置一份, (甚至不能实时更新, 需要 gradle clean ), 而实际">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2023-04-18T08:13:30.000Z">
<meta property="article:modified_time" content="2025-10-19T11:42:35.217Z">
<meta property="article:author" content="Buffer">
<meta property="article:tag" content="AGP">
<meta property="article:tag" content="Gradle">
<meta property="article:tag" content="plugin">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://lenonwang.github.io/2023/04/18/%E5%BC%80%E5%A7%8B%E4%BD%BF%E7%94%A8Android%20Gradle%20Plugin%E6%9D%A5%E5%B8%AE%E5%8A%A9%E4%BD%A0%E8%BF%9B%E8%A1%8C%E9%A1%B9%E7%9B%AE%E7%9A%84%E6%9E%84%E5%BB%BA/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://lenonwang.github.io/2023/04/18/%E5%BC%80%E5%A7%8B%E4%BD%BF%E7%94%A8Android%20Gradle%20Plugin%E6%9D%A5%E5%B8%AE%E5%8A%A9%E4%BD%A0%E8%BF%9B%E8%A1%8C%E9%A1%B9%E7%9B%AE%E7%9A%84%E6%9E%84%E5%BB%BA/","path":"2023/04/18/开始使用Android Gradle Plugin来帮助你进行项目的构建/","title":"开始使用Android Gradle Plugin来帮助你进行项目的构建"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>开始使用Android Gradle Plugin来帮助你进行项目的构建 | 程序猿</title>
  






  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">程序猿</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">Half as much, twice as elegant.</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link"><span class="nav-number">1.</span> <span class="nav-text">开始使用Android Gradle Plugin来帮助你进行项目的构建</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#0-%E5%9C%A8%E5%BC%80%E5%A7%8B%E4%B9%8B%E5%89%8D"><span class="nav-number">1.1.</span> <span class="nav-text">0.在开始之前</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-%E5%BC%80%E5%A7%8B%E4%BD%BF%E7%94%A8Android-Gradle-Plugin%E6%9D%A5%E5%B8%AE%E5%8A%A9%E4%BD%A0%E6%9E%84%E5%BB%BA%E7%9A%84%E9%A1%B9%E7%9B%AE"><span class="nav-number">1.2.</span> <span class="nav-text">1.开始使用Android Gradle Plugin来帮助你构建的项目</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Gradle%E5%92%8CAndroid-Gradle-Plugin%E7%9A%84%E5%8C%BA%E5%88%AB"><span class="nav-number">1.2.1.</span> <span class="nav-text">Gradle和Android Gradle Plugin的区别?</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-%E4%B8%BA%E4%BB%80%E4%B9%88%E8%A6%81%E4%BD%BF%E7%94%A8Android-Gradle-Plugin"><span class="nav-number">1.3.</span> <span class="nav-text">2.为什么要使用Android Gradle Plugin?</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-%E5%88%9B%E5%BB%BA%E6%88%91%E4%BB%AC%E8%87%AA%E5%B7%B1%E7%9A%84Android-Gradle-Plugin"><span class="nav-number">1.4.</span> <span class="nav-text">3. 创建我们自己的Android Gradle Plugin</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-1-build-gradle"><span class="nav-number">1.5.</span> <span class="nav-text">3.1 build.gradle</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-2-buildSrc"><span class="nav-number">1.6.</span> <span class="nav-text">3.2 buildSrc</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-3-Android-Gradle-Plugin-Project"><span class="nav-number">1.7.</span> <span class="nav-text">3.3 Android Gradle Plugin Project</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-3-1-%E6%89%8B%E5%8A%A8%E5%88%9B%E5%BB%BA"><span class="nav-number">1.7.1.</span> <span class="nav-text">3.3.1 手动创建</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-3-2-%E9%80%9A%E8%BF%87Gradle%E5%88%9B%E5%BB%BA"><span class="nav-number">1.7.2.</span> <span class="nav-text">3.3.2 通过Gradle创建</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%9B%E5%BB%BAAndroid-Gradle-Plugin-Project%E6%89%80%E5%9C%A8%E7%9A%84%E6%96%87%E4%BB%B6%E5%A4%B9"><span class="nav-number">1.7.2.1.</span> <span class="nav-text">创建Android Gradle Plugin Project所在的文件夹</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8gradle-init%E6%9E%84%E5%BB%BA%E9%A1%B9%E7%9B%AE"><span class="nav-number">1.7.2.2.</span> <span class="nav-text">使用gradle init构建项目</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%BC%96%E5%86%99%E6%88%91%E4%BB%AC%E8%87%AA%E5%B7%B1%E7%9A%84Plugin"><span class="nav-number">1.7.2.3.</span> <span class="nav-text">[编写我们自己的Plugin]</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8F%91%E5%B8%83%E6%8F%92%E4%BB%B6"><span class="nav-number">1.7.2.4.</span> <span class="nav-text">发布插件</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E9%85%8D%E7%BD%AEbuild-gradle"><span class="nav-number">1.7.2.4.1.</span> <span class="nav-text">配置build.gradle</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E9%85%8D%E7%BD%AE%E6%8F%92%E4%BB%B6%E8%B0%83%E7%94%A8%E4%BF%A1%E6%81%AF"><span class="nav-number">1.7.2.4.2.</span> <span class="nav-text">配置插件调用信息</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E7%94%9F%E6%88%90%E5%88%B0%E6%9C%AC%E5%9C%B0"><span class="nav-number">1.7.2.4.3.</span> <span class="nav-text">生成到本地</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%A1%B9%E7%9B%AE%E5%BC%95%E5%85%A5%E5%92%8C%E4%BD%BF%E7%94%A8"><span class="nav-number">1.7.2.5.</span> <span class="nav-text">项目引入和使用</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%BC%95%E5%85%A5"><span class="nav-number">1.7.2.5.1.</span> <span class="nav-text">引入</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#settings-gradle"><span class="nav-number">1.7.2.5.1.1.</span> <span class="nav-text">settings.gradle</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#project%E4%B8%8B%E7%9A%84build-gradle"><span class="nav-number">1.7.2.5.1.2.</span> <span class="nav-text">project下的build.gradle</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#app-module%E4%B8%8B%E7%9A%84build-gradle"><span class="nav-number">1.7.2.5.1.3.</span> <span class="nav-text">app module下的build.gradle</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E6%97%A9%E6%9C%9F%E7%89%88%E6%9C%AC%E6%9E%84%E5%BB%BA%E9%A1%B9%E7%9B%AE%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E5%8F%82%E8%80%83"><span class="nav-number">1.7.2.5.1.4.</span> <span class="nav-text">早期版本构建项目配置文件参考</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8"><span class="nav-number">1.7.2.5.2.</span> <span class="nav-text">使用</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-%E9%80%9A%E8%BF%87Android-Gradle-Plugin%E6%9D%A5%E5%B8%AE%E5%8A%A9%E6%88%91%E4%BB%AC%E4%BF%AE%E6%94%B9%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6-%E4%BB%A5%E4%BF%AE%E6%94%B9%E9%98%BF%E9%87%8C%E4%BA%91EMAS%E6%8E%A8%E9%80%81%E4%B8%BA%E4%BE%8B"><span class="nav-number">1.8.</span> <span class="nav-text">4.通过Android Gradle Plugin来帮助我们修改配置文件(以修改阿里云EMAS推送为例)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-%E6%9C%80%E5%90%8E"><span class="nav-number">1.9.</span> <span class="nav-text">-1. 最后</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-%E6%9C%80%E5%90%8E%E7%9A%84%E6%9C%80%E5%90%8E"><span class="nav-number">1.10.</span> <span class="nav-text">-2 最后的最后</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Footnotes"><span class="nav-number">1.11.</span> <span class="nav-text">Footnotes</span></a></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Buffer"
      src="/uploads/apple-touch-icon.png">
  <p class="site-author-name" itemprop="name">Buffer</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">48</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">14</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">56</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

  <a href="https://github.com/lenonwang" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://lenonwang.github.io/2023/04/18/%E5%BC%80%E5%A7%8B%E4%BD%BF%E7%94%A8Android%20Gradle%20Plugin%E6%9D%A5%E5%B8%AE%E5%8A%A9%E4%BD%A0%E8%BF%9B%E8%A1%8C%E9%A1%B9%E7%9B%AE%E7%9A%84%E6%9E%84%E5%BB%BA/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/uploads/apple-touch-icon.png">
      <meta itemprop="name" content="Buffer">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="程序猿">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="开始使用Android Gradle Plugin来帮助你进行项目的构建 | 程序猿">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          开始使用Android Gradle Plugin来帮助你进行项目的构建
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2023-04-18 16:13:30" itemprop="dateCreated datePublished" datetime="2023-04-18T16:13:30+08:00">2023-04-18</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2025-10-19 19:42:35" itemprop="dateModified" datetime="2025-10-19T19:42:35+08:00">2025-10-19</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <h1>开始使用Android Gradle Plugin来帮助你进行项目的构建</h1>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.clwater.top%2F2023%2F02%2F10%2F%25E5%25BC%2580%25E5%25A7%258B%25E4%25BD%25BF%25E7%2594%25A8Android_Gradle_Plugin%25E6%259D%25A5%25E5%25B8%25AE%25E5%258A%25A9%25E4%25BD%25A0%25E8%25BF%259B%25E8%25A1%258C%25E9%25A1%25B9%25E7%259B%25AE%25E7%259A%2584%25E6%259E%2584%25E5%25BB%25BA%2F"></a></p>
<blockquote>
<p>一切的一切到要从 <code>阿里云emas移动推送</code> 说起, 这玩意的接入过程暂且不表, 有兴趣的可以看一看, 尤其是其控制台. 接入后主要需要在 <code>build.gradle</code> 中进行配置, 同时还有一份配置文件在 <code>app</code> 目录下. 但是emas的配置文件只能配置一份, (甚至不能实时更新, 需要 <code>gradle clean</code> ), 而实际的开发使用中可能包含开发,测试和上线环境的配置. 这些配置就需要我们在构架的时候自动匹配为最近的配置文件.</p>
</blockquote>
<span id="more"></span>
<h2 id="0-在开始之前">0.在开始之前</h2>
<p>其实最开始的实现方式并不是这篇文章使用的 <code>Android Gradle Plugin</code> 的方法来解决, 遇到这个情况的时候, 第一个想到的方法是在 <code>build.gradle</code> 中修改task来实现, 但是 <code>阿里云emas移动推送</code> 是通过Gradle Plugin的形式引入的, 如果task来实现的话会在 <code>emas plugin</code> 执行后再执行我们的task, 这样就导致了对应的配置文件可能没有更新成功问题的发生.</p>
<p>第二个的想到的方法是通过shell在 <code>gradle build</code> 执行前处理对应的文件. 不过由于是团队合作的项目, 更改项目的构架方法可能会影响到其他人, 秉承着对他人影响最小的原则, 这个方法就不合适了.</p>
<p>最后就是现在的实现方法, 根据 <code>Gradle Plugin</code> 的相关特性, 我们通过自定义我们自己的 <code>Android Gradle Plugin</code> 来帮我们构架我们的项目.</p>
<h2 id="1-开始使用Android-Gradle-Plugin来帮助你构建的项目">1.开始使用Android Gradle Plugin来帮助你构建的项目</h2>
<p>当我们创建一个新的项目的时候, 在默认的配置文件中我们就能看到以下使用的插件信息. 当然不仅仅官方可以发布插件, 我们也可以创建和发布我们自己的插件. 用官方的解释来说就是 <a target="_blank" rel="noopener" href="https://juejin.cn/post/7201052651755913277#user-content-fn-1">1</a>:“Android Gradle 插件 (AGP) 是官方的 Android 应用构建系统。该系统支持编译多种不同类型的源代码，以及将其链接到可在实体 Android 设备或模拟器上运行的应用中。” 简单概括来说, Android Gradle Plugin就是可以在Android构架的时候将那些可重复使用的构建逻辑抽出来, 作为一个独立的项目/插件, 应用在不同的项目构建中. 例如多渠道打包, 修改图片, 压缩图片等相关的操作都可以作为一个插件来应用到不同的项目中.</p>
<h3 id="Gradle和Android-Gradle-Plugin的区别">Gradle和Android Gradle Plugin的区别?</h3>
<p>Gradle和Android Gradle Plugin是两个不同的方向和功能, Gradle是用来进行项目的构建, 而Android Gradle Plugin是一个构建的动作, 和我们项目中的.gradle文件功能相同.</p>
<h2 id="2-为什么要使用Android-Gradle-Plugin">2.为什么要使用Android Gradle Plugin?</h2>
<p>可能在初次接触到类似问题的时候都会有这样的问题, 这玩应到底有啥用?</p>
<p>如果你打包过.apk, 那么你就是 <code>Android Gradle Plugin</code> 的头号潜在用户.</p>
<p>我们可以构建我们自己的 <code>Android Gradle Plugin</code> 来帮助我们实现以下的功能</p>
<ul>
<li>资源的预处理: 压缩图片, 修改资源内容</li>
<li>配置文件的处理: 根据不同flavor更新不同的配置文件内容</li>
<li>自定义规则添加: 针对项目中自定的规则进行检查</li>
<li>AOP: 切面添加相关代码</li>
</ul>
<p>当然, <code>Android Gradle Plugin</code> 能做的不仅仅是这些, 我们还可以根据我们自己的需求来修改创建满足自己的特殊功能的 <code>Android Gradle Plugin</code></p>
<h2 id="3-创建我们自己的Android-Gradle-Plugin">3. 创建我们自己的Android Gradle Plugin</h2>
<p><code>Android Gradle Plugin</code> 有三种创建的方法,</p>
<h2 id="3-1-build-gradle">3.1 build.gradle</h2>
<p>第一种就是直接在app module的build.gradle文件中添加以下代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">// 编写plugin类</span><br><span class="line">class DemoPlugin implements Plugin&lt;Project&gt;&#123; @Override void apply(Project project) &#123; println &quot;===============&quot; println &quot;DemoPlugin&quot; println &quot;===============&quot; &#125;</span><br><span class="line">&#125; // 使用自定义Plugin</span><br><span class="line">apply plugin: DemoPlugin 复制代码</span><br></pre></td></tr></table></figure>
<p>我们Sync后就可以在 <code>Build</code> 窗口中看到以下的数据了.</p>
<p>这种使用的方法最大的有点就是简单简洁, 最大的缺点是太过简单简洁, 最适合的是小功能, 并且没有可移植性, 只能跟着build.gradle文件走.</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fclwater%2FFirst_Gradle_Plugin_of_Android%2Fblob%2Fmaster%2FFirst_Gradle_Plugin_of_Android_Test_1%2Fapp%2Fbuild.gradle">GitHub文件地址:https://github.com/clwater/First_Gradle_Plugin_of_Android/blob/master/First_Gradle_Plugin_of_Android_Test_1/app/build.gradle</a></p>
<h2 id="3-2-buildSrc">3.2 buildSrc</h2>
<p>第二章方法是在项目中创建新的module, 并且命名为 <code>buildSrc</code>.</p>
<p>构建后的文件目录结构如下, 具体的详情说明会在后面进行详细的说明.</p>
<p>当然, 在使用的使用仍需要在 <code>build.gradle</code> 中添加以下内容</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">apply plugin: &#x27;com.clwater.plugin&#x27; // 这个名字和我们.properties文件的名字一致</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>
<p>此时我们再sync项目, 可以看到如下输出</p>
<p>这种方法具有一定的复用性, 在项目中的每个module可以使用, 但是对外仍不可使用.</p>
<blockquote>
<p>Tips: module只能命名为 <code>buildSrc</code>, 并且在 <code>settings.gradle</code> 将自动添加的 <code>include ':buildSrc'</code> 移除</p>
</blockquote>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fclwater%2FFirst_Gradle_Plugin_of_Android%2Fblob%2Fmaster%2FFirst_Gradle_Plugin_of_Android_Test_2%2Fapp%2Fbuild.gradle">GitHub文件地址:https://github.com/clwater/First_Gradle_Plugin_of_Android/blob/master/First_Gradle_Plugin_of_Android_Test_2/app/build.gradle</a></p>
<h2 id="3-3-Android-Gradle-Plugin-Project">3.3 Android Gradle Plugin Project</h2>
<p>顾名思义, 我们可以在独立的Project中创建我们的 <code>Android Gradle Plugin</code>,</p>
<p>当然创建的方法也不止一种, 可以酌情根据时间情况来选择如果进行创建, 以下推荐与否, 全凭主观臆断.</p>
<h3 id="3-3-1-手动创建">3.3.1 手动创建</h3>
<blockquote>
<p>纯主观臆断不推荐</p>
</blockquote>
<p>因为自己创建的时候需要手动配置关联的内容, 但是这些关联的内容对刚刚接触此部分的开发者来说, 又十分的零碎, 往往最后不得其法, 导致由于各种或理解或遗漏的小问题造成的运行结果不达预期.</p>
<h3 id="3-3-2-通过Gradle创建">3.3.2 通过Gradle创建</h3>
<p>既然是 <code>Android Gradle Plugin</code>, 那得先是 <code>Gradle</code> 中能用的, 才能扩展到 <code>Android Gradle</code> 中, Gradle也提供了一个自动创建的方法, 来避免我们手动创建时引发的各种问题. 也方便相关流程的规范化.</p>
<h4 id="创建Android-Gradle-Plugin-Project所在的文件夹">创建Android Gradle Plugin Project所在的文件夹</h4>
<p>这里我们之间创建一个文件夹, 用作我们Android Gradle Plugin对应Project的所在目录</p>
<h4 id="使用gradle-init构建项目">使用gradle init构建项目</h4>
<blockquote>
<p>此章节使用的gradle指令时, 如无法找到相关指令, 检查gradle是否安装配置, 详情参考 <a href="https://link.juejin.cn?target=">Gradle | Installation: https://gradle.org/install/</a></p>
</blockquote>
<p>我们在终端中打开刚刚创建的目录, 并进行以下操作</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">gradle init Select type of project to generate: 1: basic 2: application 3: library 4: Gradle plugin</span><br><span class="line">Enter selection (default: basic) [1..4] 4</span><br><span class="line"># 选择生成的Gradle项目类型, 我们需要选择4: Gradle plugin Select implementation language: 1: Groovy 2: Java 3: Kotlin</span><br><span class="line">Enter selection (default: Java) [1..3] 1</span><br><span class="line"># 选择插件的编码使用语言, 这里推荐使用Groovy(相关教程及内容最多) Select build script DSL: 1: Groovy 2: Kotlin</span><br><span class="line">Enter selection (default: Groovy) [1..2] 1</span><br><span class="line"># 选择项目的编译脚本语言(类似build.gradle文件), 推荐使用Groovy, 理由同上 Generate build using new APIs and behavior (some features may change in the next minor release)? (default: no) [yes, no] no</span><br><span class="line"># 是否启用一些新的实验性的APIs来进行构建, 如果没有特殊需求的话不启用即可 Project name (default: First_Gradle_Plugin_of_Android_Test_3): plugin</span><br><span class="line"># Project的名称, 默认为你对应文件的名称, 实际上是你对应module的名称 Source package (default: plugin): com.clwater.plugin</span><br><span class="line"># 包名的完整地址, 更改为你的地址即可 &gt; Task :init</span><br><span class="line">Get more help with your project: https://docs.gradle.org/8.0/userguide/custom_plugins.html BUILD SUCCESSFUL in 1m 19s</span><br><span class="line">2 actionable tasks: 2 executed 复制代码</span><br></pre></td></tr></table></figure>
<p>最终的构建结果如下:</p>
<h4 id="编写我们自己的Plugin">[编写我们自己的Plugin]</h4>
<p>打开默认生成的 <code>.groovy</code> 文件, 我就就此文件进行简单的修改, 方便后面的步骤进行</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">// 更改下默认生成的文件名</span><br><span class="line">class ClwaterPlugin implements Plugin&lt;Project&gt; &#123; void apply(Project project) &#123; // 输出一下插件被调用 println(&quot;Hello from plugin&quot;) // 注册一个名叫greeting的task project.tasks.register(&quot;greeting&quot;) &#123; doLast &#123; println(&quot;Hello from plugin &#x27;com.clwater.plugin.greeting&#x27;&quot;) &#125; &#125; &#125;</span><br><span class="line">&#125;</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>
<blockquote>
<p>关于Gradle Task的相关内容, 这里不再额外赘述, 如果大家感喜欢我的文章风格的话, 我可以再帮大家整理一下.</p>
</blockquote>
<h4 id="发布插件">发布插件</h4>
<p>当我们在Project中创建好并完成了我们自己的 <code>Android Gradle Plugin</code> 后, 下一步就是将它提供给第三方,</p>
<h5 id="配置build-gradle">配置build.gradle</h5>
<p>接下来就是在 <code>build.gradle</code> 中添加额外的发布配置, 构建出来的插件如不配置指定的 <code>repositories</code> 会在系统默认的mavenLocal中生成, 这里为了更直观便捷的使用, 我们将其生成在项目内.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">plugins &#123; ... id &#x27;maven-publish&#x27;</span><br><span class="line">&#125; ...</span><br><span class="line">publishing &#123; publications &#123; // 此处clwater可以随便写，但是后面的MavenPublication不能随便写 clwater(MavenPublication) &#123; // 插件的组ID groupId = &#x27;com.clwater.plugin&#x27; // 插件的ID artifactId = &#x27;Plugin&#x27; // 插件的版本 version = &#x27;1.0.0&#x27; // 插件的发布类型 from components.java &#125; &#125; repositories &#123; maven &#123; // 插件的发布仓库 name = &#x27;repo&#x27; // 插件的发布仓库地址 url = &quot;../repo&quot; &#125; &#125;</span><br><span class="line">&#125; ... 复制代码</span><br></pre></td></tr></table></figure>
<p>此时我们再使用 <code>gradle tasks</code> 就可以看到我们的发布task了.</p>
<h5 id="配置插件调用信息">配置插件调用信息</h5>
<p>我们可以看到在 <code>main</code> 文件夹下有 <code>groovy</code> 和 <code>resources</code> 两个文件夹, <code>groovy</code> 包含了我们的插件代码, 而 <code>resources</code> 文件夹则需要包含我们的插件声明文件.</p>
<p>为了使得我们的插件可以被调用, 我们需要配置相关的声明. 主要是在 <code>resources</code> 目录下添加 <code>META-INF</code>, 并在 <code>META-INF</code> 中添加 <code>gradle-plugins</code>, 在 <code>gradle-plugins</code> 添加 <code>com.clwater.plugin.properties</code>, 当然这个文件的名字我们可以随便定义. 没有约束性要求. 最后的文件目录结果如下:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">main</span><br><span class="line">├── groovy</span><br><span class="line">│ └── com</span><br><span class="line">│ └── clwater</span><br><span class="line">│ └── plugin</span><br><span class="line">│ └── ClwaterPlugin.groovy</span><br><span class="line">└── resources └── META-INF └── gradle-plugins └── com.clwater.plugin.properties</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>
<p>关于 <code>com.clwater.plugin.properties</code>, 我们需要配置我们插件的入口, 形式如下:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">implementation-class=com.clwater.plugin.ClwaterPlugin</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>
<h5 id="生成到本地">生成到本地</h5>
<p>由于我的 <code>build.gradle</code> 文件中配置的名称为 <code>clwater</code>, 所以我的最终的文件生成task应该使用 <code>publishClwaterPublicationToRepoRepository</code>, 当我们自己开发的时候, 酌情根据自己的情况进行修改.</p>
<p>当然, 你也可以在Android Studio的Gradle窗口中找到相关的构建Task</p>
<p>当我们的发布task完成后, 就可以发现项目中多了一个repo的目录, 同时我们的插件也发布到了此处.</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fclwater%2FFirst_Gradle_Plugin_of_Android%2Fblob%2Fmaster%2FFirst_Gradle_Plugin_of_Android_Test_3">GitHub文件地址:https://github.com/clwater/First_Gradle_Plugin_of_Android/blob/master/First_Gradle_Plugin_of_Android_Test_3</a></p>
<h4 id="项目引入和使用">项目引入和使用</h4>
<p>当我们的项目构建完成后, 就可以提供给别的项目进行使用了, 我们先构建一个新的项目,</p>
<blockquote>
<p>由于使用的gradle版本为gradle-7.5, 项目中gradle相关文件可能有所不用, 酌情根据项目实际情况来进行配置.</p>
</blockquote>
<h5 id="引入">引入</h5>
<p>首先是将我们生成好的 <code>Android Gradle Plugin</code> 所在的 <code>repo</code> 文件夹复制到项目中, 然后依次修改以下文件</p>
<h6 id="settings-gradle">settings.gradle</h6>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">pluginManagement &#123; repositories &#123;</span><br><span class="line">+ gradlePluginPortal() google() mavenCentral()</span><br><span class="line">- gradlePluginPortal()</span><br><span class="line">+ //增加本地仓库</span><br><span class="line">+ maven &#123;</span><br><span class="line">+ allowInsecureProtocol(true)</span><br><span class="line">+ url uri(&#x27;./repo&#x27;)</span><br><span class="line">+ &#125; &#125; &#125; dependencyResolutionManagement &#123;</span><br><span class="line">@@ -10,6 +15,11 @@ dependencyResolutionManagement &#123; repositories &#123; google() mavenCentral()</span><br><span class="line">+ //增加本地仓库</span><br><span class="line">+ maven &#123;</span><br><span class="line">+ allowInsecureProtocol(true)</span><br><span class="line">+ url uri(&#x27;./repo&#x27;)</span><br><span class="line">+ &#125; &#125; &#125;</span><br><span class="line">rootProject.name = &quot;First_Gradle_Plugin_of_Android_Test_4&quot;</span><br><span class="line">include &#x27;:app&#x27;</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>
<p>简单来说就是向两个 <code>repositories</code> 中添加我们使用的本地仓库</p>
<h6 id="project下的build-gradle">project下的build.gradle</h6>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">+ buildscript &#123;</span><br><span class="line">+ dependencies &#123;</span><br><span class="line">+ classpath(&#x27;com.clwater.plugin:Plugin:1.0.0&#x27;)</span><br><span class="line">+ &#125;</span><br><span class="line">+ &#125;</span><br><span class="line">+ // Top-level build file where you can add configuration options common to all sub-projects/modules.</span><br><span class="line">plugins &#123; id &#x27;com.android.application&#x27; version &#x27;7.4.0&#x27; apply false id &#x27;com.android.library&#x27; version &#x27;7.4.0&#x27; apply false id &#x27;org.jetbrains.kotlin.android&#x27; version &#x27;1.7.21&#x27; apply false</span><br><span class="line">&#125; 复制代码</span><br></pre></td></tr></table></figure>
<p>添加我们的插件(groupId:Id:version的格式)</p>
<h6 id="app-module下的build-gradle">app module下的build.gradle</h6>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">plugins &#123; id &#x27;com.android.application&#x27; id &#x27;org.jetbrains.kotlin.android&#x27;</span><br><span class="line">+ id &#x27;com.clwater.plugin&#x27;</span><br><span class="line">&#125; android &#123; namespace &#x27;com.clwater.first_gradle_plugin_of_android_test_4&#x27; compileSdk 33 ...</span><br><span class="line">&#125;</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>
<blockquote>
<p>Tips: id 'com.clwater.plugin’中的内容和我们配置 <code>resources</code> 文件夹下的 <code>.properties</code> 需要完全一致</p>
</blockquote>
<h6 id="早期版本构建项目配置文件参考">早期版本构建项目配置文件参考</h6>
<p>早期的项目修改起来比较容易, <code>app</code> 下的 <code>build.gradle</code> 配置完全一致, 我们要修改的只有项目根目录下的 <code>build.gradle</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">// Top-level build file where you can add configuration options common to all sub-projects/modules. buildscript &#123; repositories &#123;</span><br><span class="line">+ maven &#123;</span><br><span class="line">+ url uri(&#x27;./repo&#x27;)</span><br><span class="line">+ &#125; mavenCentral() google() jcenter() &#125; dependencies &#123; classpath &#x27;com.android.tools.build:gradle:4.2.1&#x27; classpath &#x27;org.owasp:dependency-check-gradle:6.0.5&#x27; // ★追加</span><br><span class="line">+ classpath &#x27;com.clwater.plugin:Plugin:1.0.0&#x27; &#125;</span><br><span class="line">&#125; apply plugin: &#x27;org.owasp.dependencycheck&#x27; // ★追加 allprojects &#123; repositories &#123;</span><br><span class="line">+ maven &#123;</span><br><span class="line">+ url uri(&#x27;./repo&#x27;)</span><br><span class="line">+ &#125; mavenCentral() google() jcenter() &#125;</span><br><span class="line">&#125; 复制代码</span><br></pre></td></tr></table></figure>
<h5 id="使用">使用</h5>
<p>其实当然引入之后就已经再使用了, 当我们重新构建项目的时候就可以在 <code>build</code> 视图中看到如下内容</p>
<p>我们可以看到在 <code>ClwaterPlugin</code> 中的输出语句被调用了. 说明我们的插件已经被执行了.</p>
<p>同时我们执行 <code>./gradlew tasks --all</code>, 就可以找到我们定义的 <code>greeting</code> task,</p>
<p>当然, 直接执行的时候也是可以的.</p>
<blockquote>
<p>Tips: 截止此处, 我们已经可以通过任意方式来创建一个 <em>Android Gradle Plugin</em> 并将其在任意的项目中使用了, 但是其实还有一个疑问, <em>Android Gradle Plugin</em> 可以帮助我们做什么?</p>
</blockquote>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fclwater%2FFirst_Gradle_Plugin_of_Android%2Fblob%2Fmaster%2FFirst_Gradle_Plugin_of_Android_Test_4e">GitHub文件地址:https://github.com/clwater/First_Gradle_Plugin_of_Android/blob/master/First_Gradle_Plugin_of_Android_Test_4</a></p>
<h2 id="4-通过Android-Gradle-Plugin来帮助我们修改配置文件-以修改阿里云EMAS推送为例">4.通过Android Gradle Plugin来帮助我们修改配置文件(以修改阿里云EMAS推送为例)</h2>
<p>前文提到过&quot;如果你打包过.apk, 那么你就是 <code>Android Gradle Plugin</code> 的头号潜在用户.&quot;, 因为 <code>Android Gradle Plugin</code> 可以帮助我们做许多不得不做, 有具有重复性的事情.比如此章的情况: <em>通过Android Gradle Plugin来帮助我们修改配置文件(以修改阿里云EMAS推送为例)</em></p>
<blockquote>
<p>阿里云EMAS是一个第三方的推送插件, 可以进行数据的推送, 接入过程不过去描述, 我们使用 <code>Android Gradle Plugin</code> 来解决的问题是: EMAS的配置文件唯一, 无法配置多个文件, 如果不自动化配置的话, 那么上线和测试开发时使用的配置文件要不只能使用一个, 要不需要打包前手动修改, 而只有一套配置文件来开发上线显然是不应该的, 同时如果多套的话, 手动来进行打包前的修改也是不可靠的. 最终还是需要进行自动化配置.</p>
</blockquote>
<p>参考代码如下:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">package com.clwater.plugin import org.gradle.TaskExecutionRequest</span><br><span class="line">import org.gradle.api.GradleException</span><br><span class="line">import org.gradle.api.Plugin</span><br><span class="line">import org.gradle.api.Project</span><br><span class="line">import org.gradle.api.invocation.Gradle class ClwaterPlugin implements Plugin&lt;Project&gt;&#123; // 不同的渠道 enum BuildType &#123; PRODUCT, DEV, TEST, NONE ; &#125; // project持有 private Project project // 配置文件路径 // ali push 配置文件路径(preBuild使用) private String emasFromFile // ali push 配置文件路径(/app实际构建) private String emasToFile private buildType = BuildType.NONE; /** * 插件入口 * step1: 检查xxx(配置文件路径)文件夹是否存在 * step2: 检查是否构建为生产环境 * step3: 拷贝xxx内容文件夹到app文件夹 * step3.1: 拷贝ali push配置文件 * step4: 构建完成后删除相关文件 * @param project */ @Override void apply(Project project) &#123; println(&#x27;==================================================&#x27;) println(&#x27;ClwaterPlugin is applying&#x27;) this.project = project buildType = getBuildType(project) println(&quot;ClwaterPlugin: buildType: $buildType&quot;) deleteEAMSCache() initBaseConfig() if (checkPreBuildFile())&#123; throw new GradleException(&quot;File not found: $emasFromFile&quot;) &#125; movePreBuildFile() project.gradle.buildFinished &#123; println(&#x27;==================================================&#x27;) println(&#x27;ClwaterPlugin: finished&#x27;) println(&#x27;ClwaterPlugin: delete cache file&#x27;) deleteCache() println(&#x27;==================================================&#x27;) &#125; &#125; /** * 删除阿里推送emas缓存文件, 避免新的配置文件无法生效 */ private void deleteEAMSCache()&#123; Gradle gradle = project.gradle println(&quot; del: $project.rootDir/app/build/generated/res/emas-services&quot;) project.delete(&quot;$project.rootDir/app/build/generated/res/emas-services&quot;) List&lt;TaskExecutionRequest&gt; taskExecutionRequests = gradle.getStartParameter().getTaskRequests() for (TaskExecutionRequest taskExecutionRequest: taskExecutionRequests) &#123; if (taskExecutionRequest.args.toString().contains(&quot;assemble&quot;))&#123; String variant = taskExecutionRequest.args.toString() variant = variant.replace(&quot;[&quot;, &quot;&quot;) variant = variant.replace(&quot;]&quot;, &quot;&quot;) variant = variant.replace(&quot;:app:&quot;, &quot;&quot;) variant = variant.replace(&quot;assemble&quot;, &quot;&quot;) variant = &quot;merge&quot; + variant + &quot;Resources&quot; // 提取构建variant println(&quot; del: $project.rootDir/app/build/intermediates/incremental/$variant/merger.xml&quot;) project.delete(&quot;$project.rootDir/app/build/intermediates/incremental/$variant/merger.xml&quot;) &#125; &#125; &#125; /** * 初始化基础配置 */ private void initBaseConfig()&#123; switch (buildType)&#123; case BuildType.PRODUCT: emasFromFile = &quot;xxx/product/aliyun-emas-services.json&quot; break case BuildType.DEV: emasFromFile = &quot;xxx/dev/aliyun-emas-services.json&quot; break case BuildType.TEST: emasFromFile = &quot;xxx/test/aliyun-emas-services.json&quot; break &#125; emasToFile = &quot;$project.rootDir/app&quot; &#125; /** * 拷贝preBuild对应文件到app文件夹 */ private void movePreBuildFile()&#123; moveEmas() &#125; /** * 拷贝文件 * @param fromPath * @param toPath */ private void copyFile(String fromPath, String toPath)&#123; project.copy &#123; from fromPath into toPath &#125; &#125; /** * 复制配置文件 */ private void moveEmas()&#123; copyFile(emasFromFile, emasToFile) &#125; /** * 检查是否构建为生产环境 * @param project * @return */ private static BuildType getBuildType(Project project)&#123; Gradle gradle = project.gradle List&lt;TaskExecutionRequest&gt; taskExecutionRequests = gradle.getStartParameter().getTaskRequests() for (TaskExecutionRequest taskExecutionRequest: taskExecutionRequests)&#123; if(taskExecutionRequest.args.toString().contains(&quot;assemble&quot;))&#123; // 检查是否为Dev/Test/Product &#125; &#125; return BuildType.DEV &#125; /** * 检查预构建文件是否存在 * @return */ private boolean checkPreBuildFile()&#123; // 检查emas配置文件是否存在 File emasFile = new File(emasFromFile) return !emasFile.isFile() &#125; /** * 删除相关文件 */ private void deleteCache()&#123; project.delete(emasToFile+ &quot;/aliyun-emas-services.json&quot;) &#125;</span><br><span class="line">&#125;</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>
<p>至此, 我们就完成了针对阿里EMAS的多版本配置文件的自动化配置, 再也不用担心人工配置可能引起的各种问题了.</p>
<h2 id="1-最后">-1. 最后</h2>
<p>相信至此大家已经对 <code>Android Gradle Plugin</code> 有了一定的了解, 也希望此文可以帮助到大家, 更欢迎大家一起交流.</p>
<h2 id="2-最后的最后">-2 最后的最后</h2>
<p>项目完整代码可以访问:<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fclwater%2FFirst_Gradle_Plugin_of_Android">我的GitHub: https://github.com/clwater/First_Gradle_Plugin_of_Android</a></p>
<h2 id="Footnotes">Footnotes</h2>
<ol>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Fstudio%2Fbuild%2Fextend-agp%3Fhl%3Dzh-cn">developer.android.com/studio/buil…</a> <a target="_blank" rel="noopener" href="https://juejin.cn/post/7201052651755913277#user-content-fnref-1">↩</a></li>
</ol>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/AGP/" rel="tag"># AGP</a>
              <a href="/tags/Gradle/" rel="tag"># Gradle</a>
              <a href="/tags/plugin/" rel="tag"># plugin</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2023/04/18/Mac-m1%E8%8A%AF%E7%89%87-%E5%AE%89%E8%A3%85homebrew/" rel="prev" title="Mac m1芯片 安装homebrew">
                  <i class="fa fa-chevron-left"></i> Mac m1芯片 安装homebrew
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2023/05/23/%E6%AF%8F%E5%A4%A9%E4%B8%80%E9%81%93%E7%AE%97%E6%B3%95%E9%A2%98/" rel="next" title="每天一到算法题之“旋转数组”">
                  每天一到算法题之“旋转数组” <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Buffer</span>
</div>

    </div>
  </footer>

  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  
<script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.0/search.js" integrity="sha256-vXZMYLEqsROAXkEw93GGIvaB2ab+QW6w3+1ahD9nXXA=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>





  





</body>
</html>
